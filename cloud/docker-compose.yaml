# Cloud (photo, files, notes) Stack
# - PostgreSQL
# - Redis
# - Immich
# - Trillium, BookStack, Outline, Siyuan as Note/Wiki later
#
# Usage: docker compose up -d --force-recreate --remove-orphans --pull always

name: cloud-stack

networks:
  cloud-network:
    external: true
  # Connect to Observability
  # observability-network:
  #   external: true

# Named volumes for databases
volumes:
  postgres-data:
  redis-data:

services:
  # ---------- DATA STORES ----------
  postgres:
    image: pgvector/pgvector:pg17
    container_name: cloud-postgres
    restart: always
    environment:
      - TZ=${GENERIC_TIMEZONE:-UTC}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DB_STORAGE_TYPE=SSD
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      - PGDATA=/var/lib/postgresql/data
      # POSTGRES_DB not set on purpose; we create 3 DBs via init SQL
    volumes:
      # Named volume for database (managed via SQL dumps)
      - postgres-data:/var/lib/postgresql/data
      - ./postgres-initdb:/docker-entrypoint-initdb.d:ro   # place 01-init.sql here
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - cloud-network
    #  - observability-network

  redis:
    image: redis:latest
    container_name: cloud-redis
    restart: always
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      - TZ=${GENERIC_TIMEZONE:-UTC}
    volumes:
      - redis-data:/data
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cloud-network
    #  - observability-network

  # ---------- IMMICH ----------
  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: cloud-immich-server
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - TZ=${GENERIC_TIMEZONE:-UTC}
      # Database
      - DB_HOSTNAME=postgres
      - DB_PORT=5432
      - DB_USERNAME=${IM_DB_USER}
      - DB_PASSWORD=${IM_DB_PASS}
      - DB_DATABASE_NAME=immich_db
      # Redis
      - REDIS_HOSTNAME=redis
      - REDIS_PORT=6379
      # Upload/media
      - IMMICH_MEDIA_LOCATION=/usr/src/app/upload
      - IMMICH_LOG_LEVEL=${IMMICH_LOG_LEVEL:-log}
      # Optional auth & public URL
      - IMMICH_SERVER_URL=${IMMICH_SERVER_URL}
    volumes:
      - /mnt/s/immich/uploads:/usr/src/app/upload
      - /mnt/s/immich/thumbs:/usr/src/app/thumbs
      - /mnt/s/photo_archive/:/mnt/s/photo_archive:ro
    security_opt:
      - no-new-privileges:true
    healthcheck:
      disable: false
    ports:
      - ${IMMICH_PORT:-2283}:2283
    networks:
      - cloud-network
    #  - observability-network

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: cloud-immich-ml
    restart: always
    # Only use GPU runtime if you have NVIDIA GPU
    runtime: nvidia
    environment:
      # Only if using NVIDIA GPU
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - TZ=${GENERIC_TIMEZONE}
      - MACHINE_LEARNING_HOST=0.0.0.0
      - MACHINE_LEARNING_PORT=3003
      - MACHINE_LEARNING_WORKERS=${IMMICH_ML_WORKERS:-1}
      - MACHINE_LEARNING_WORKER_TIMEOUT=${IMMICH_ML_TIMEOUT:-120}
    volumes:
      - /mnt/s/immich/model-cache:/cache
    security_opt:
      - no-new-privileges:true
    healthcheck:
      disable: false
    networks:
      - cloud-network
    #  - observability-network
